{% extends 'web/es/base.html' %}
{% load staticfiles %}
{% load bootstrap3 %}

{% block contenido %}

    <link href="{% static 'css/dropzone.css' %}" type="text/css" rel="stylesheet"/>
    <a name="contenido"></a>
    <div class="content-section-a">
        <div class="container">
            <h1>Por favor, completa el siguiente formulario</h1>
                                <!-- IMPORTANT enctype attribute! -->
                <form method="POST" class="container dropzone" id="myDropzone" enctype="multipart/form-data" >
​
                    {% csrf_token %}
                    <h3>Crea tu casa</h3>
                    <hr>
​
                    {% bootstrap_form formCasa layout='horizontal'%}


                    <div>
                        {% for foto in casa.fotos.all %}
                        <img class="media-object" src="{{foto.foto.url}}" alt="120x120" data-src="holder.js/120x120" style="width: 120px; height: 120px;" data-holder-rendered="true">
                        <button>
                            <a href="{% url 'delete_house_image' path_image=foto.foto %}"> Borrar esta imagen </a> <!-- boton para borrar esta imagen en concreto -->
                        </button>
                        {% endfor %}

                    </div>


                    <div class='text-right'>
                        {% bootstrap_button "Guardar cambios" button_type="submit" button_class="btn-primary btremove"%}
                        {% bootstrap_button "Cancelar" button_type="link" href='/' button_class="btn-danger"%}
                    </div>
                </form>

                                <script src="{% static 'js/dropzone.js' %}"></script>
                            <script type="text/javascript">
                                Dropzone.options.myDropzone = {
                                    url:"#",
                                    // Prevents Dropzone from uploading dropped files immediately
                                    autoProcessQueue: false,
                                    addRemoveLinks: true,
                                    //probably with this it was easier to recover files
                                    paramName: "file",
                                    acceptedFiles: "image/*",
                                    maxFilesize: 5.0,
                                {% if casa.fotos.all.count == 2 %}
                                    maxFiles: 0,
                                {% elif casa.fotos.all.count == 1 %}
                                    maxFiles: 1,
                                {% else %}
                                    maxFiles: 2,
                                {% endif %}
                                    parallelUploads: 10000,
                                    uploadMultiple: true,


                                    init : function() {

                                        myDropzone=this;

                                        // You might want to show the submit button only when
                                        // files are dropped here:
                                        this.on("addedfile", function(file) {
                                            if (document.querySelectorAll(".btremove").length>0){
                                            var sub = document.querySelector(".btremove");
                                            sub.parentNode.removeChild(sub);
                                            var textright = document.querySelector(".text-right");
                                            var cancel = document.querySelector(".btn-default");
                                            var element = document.createElement("button");
                                            element.className = "btn btn-primary";
                                            element.type = "button";

                                                var data = document.createTextNode("Guardar cambios");
                                                element.appendChild(data);
                                                textright.insertBefore(element, textright.firstChild);
                                                submitButton = element;

                                                submitButton.addEventListener("click", function () {
                                                    var files = myDropzone.getAcceptedFiles();
                                                    myDropzone.processFiles(files);
                                                    var filesqueue=myDropzone.getQueuedFiles();
                                                    for(var file in filesqueue){
                                                        myDropzone.processFile(file);
                                                    }
                                                    //myDropzone.processQueue();
                                                    document.getElementById("myDropzone").submit();
                                                    // Tell Dropzone to process all queued files.
                                                });
                                            }
                                        });

                                    }
                                };
                            </script>
        </div>
        <!-- /.contenido -->
    </div>

{% endblock %}
